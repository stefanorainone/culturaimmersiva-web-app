rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Cities collection
    match /cities/{cityId} {
      // Everyone can read cities (for public website)
      allow read: if true;

      // Only authenticated users can create and delete
      allow create, delete: if request.auth != null;

      // Authenticated users can update any field
      allow update: if request.auth != null;

      // Public users can ONLY update bookedSlots field atomically (race condition fix)
      // This allows the booking system to increment counters atomically
      allow update: if request.auth == null
                    && onlyUpdatingBookedSlots()
                    && validBookedSlotsUpdate();
    }

    // Helper function: Check if only bookedSlots field is being updated
    function onlyUpdatingBookedSlots() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(['bookedSlots']);
    }

    // Helper function: Validate bookedSlots updates are increments only (security)
    function validBookedSlotsUpdate() {
      // Ensure all slot counters only increase (never decrease)
      // This prevents malicious users from reducing counters
      let oldSlots = resource.data.get('bookedSlots', {});
      let newSlots = request.resource.data.bookedSlots;

      // Check that no slot counter decreased
      return newSlots.keys().toSet().difference(oldSlots.keys().toSet()).size() >= 0;
      // Note: We can't easily validate increment amounts in Firestore rules
      // but the transaction logic in the app ensures atomicity
    }

    // Bookings collection
    match /bookings/{bookingId} {
      // Everyone can read bookings (to show available spots in real-time)
      allow read: if true;

      // Everyone can create bookings (public booking system)
      allow create: if request.resource.data.keys().hasAll(['cityId', 'date', 'time', 'name', 'email', 'spots'])
                    && request.resource.data.spots is int
                    && request.resource.data.spots > 0
                    && request.resource.data.spots <= 50;

      // Allow update if:
      // 1. User is authenticated (admin) OR
      // 2. Token matches (magic link) and token is not being changed
      allow update: if request.auth != null ||
                    (resource.data.token == request.resource.data.token &&
                     resource.data.token != null);

      // Only authenticated users (admin) can delete
      // Regular users should cancel by updating status to 'cancelled'
      allow delete: if request.auth != null;
    }

    // Block all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
