rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Cities collection
    match /cities/{cityId} {
      // Everyone can read cities (for public website)
      allow read: if true;

      // Only authenticated users can create and delete
      allow create, delete: if request.auth != null;

      // Authenticated users can update any field
      allow update: if request.auth != null;

      // Public users can ONLY update bookedSlots field atomically (race condition fix)
      // This allows the booking system to increment counters atomically
      allow update: if request.auth == null
                    && onlyUpdatingBookedSlots()
                    && validBookedSlotsUpdate();

      // Subcollection for tracking unique views per IP (written by Cloud Function)
      match /views/{viewId} {
        // Only Cloud Functions (admin SDK) can write
        // Public can't read or write
        allow read, write: if false;
      }
    }

    // Helper function: Check if only bookedSlots field is being updated
    function onlyUpdatingBookedSlots() {
      let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
      return affectedKeys.hasOnly(['bookedSlots']);
    }

    // Helper function: Validate bookedSlots updates are increments only (security)
    function validBookedSlotsUpdate() {
      // Basic validation: ensure bookedSlots exists and is a map
      // The application uses atomic transactions to ensure only increments occur
      // Additional validation in security rules is limited due to language constraints
      return request.resource.data.bookedSlots is map;
    }

    // Bookings collection
    match /bookings/{bookingId} {
      // Read permissions:
      // 1. Authenticated users (admin) can read all bookings
      // 2. Public users can only query with a valid token (for magic links)
      // Note: We can't validate query parameters in Firestore rules, so we rely on
      // the app to only query with tokens and not expose all bookings
      allow get: if request.auth != null ||
                    (resource.data.token != null && resource.data.token.size() > 0);

      // List/query is restricted to authenticated users only (admin)
      // This prevents enumeration attacks where someone could list all bookings
      allow list: if request.auth != null;

      // Everyone can create bookings (public booking system)
      // Validate required fields and sensible limits
      allow create: if request.resource.data.keys().hasAll(['cityId', 'date', 'time', 'name', 'email', 'spots'])
                    && request.resource.data.spots is int
                    && request.resource.data.spots > 0
                    && request.resource.data.spots <= 50
                    && request.resource.data.name is string
                    && request.resource.data.name.size() >= 2
                    && request.resource.data.email is string
                    && request.resource.data.email.matches('.*@.*\\..*');

      // Allow update if:
      // 1. User is authenticated (admin) OR
      // 2. Token matches (magic link) and token is not being changed
      allow update: if request.auth != null ||
                    (resource.data.token == request.resource.data.token &&
                     resource.data.token != null &&
                     request.resource.data.token == resource.data.token);

      // Only authenticated users (admin) can delete
      // Regular users should cancel by updating status to 'cancelled'
      allow delete: if request.auth != null;
    }

    // Timeslots collection
    match /timeslots/{slotId} {
      // Everyone can read timeslots
      allow read: if true;

      // Authenticated users (admin) can create, update, delete
      allow create, update, delete: if request.auth != null;
    }

    // Settings collection
    match /settings/{settingId} {
      // Everyone can read settings
      allow read: if true;

      // Only authenticated users (admin) can write
      allow create, update, delete: if request.auth != null;
    }

    // Reminder History collection
    match /reminderHistory/{historyId} {
      // Only authenticated users (admin) can read/write
      allow read, write: if request.auth != null;
    }

    // Articles collection (Blog)
    match /articles/{articleId} {
      // Everyone can read articles (filtering done client-side for published status)
      // Admin protection is handled by React ProtectedRoute
      allow read: if true;

      // Only authenticated users (admin) can write
      allow create, update, delete: if request.auth != null;
    }

    // WhatsApp Conversations collection
    match /whatsapp_conversations/{conversationId} {
      // Only authenticated users (admin) can read/write
      allow read, write: if request.auth != null;
    }

    // WhatsApp Messages collection
    match /whatsapp_messages/{messageId} {
      // Only authenticated users (admin) can read/write
      allow read, write: if request.auth != null;
    }

    // WhatsApp Templates collection
    match /whatsapp_templates/{templateId} {
      // Only authenticated users (admin) can read/write
      allow read, write: if request.auth != null;
    }

    // Operators collection
    match /operators/{operatorId} {
      // Authenticated users can read all operators (needed for admin to assign operators to cities)
      allow read: if request.auth != null;
      // Only admin can create/update/delete operators
      allow write: if request.auth != null;
    }

    // FCM Tokens collection (for push notifications)
    match /fcm_tokens/{tokenId} {
      // Authenticated users can read/write their own tokens
      allow read, write: if request.auth != null;
    }

    // Reviews collection (for feedback system)
    match /reviews/{reviewId} {
      // Everyone can read and create reviews (public feedback)
      allow read, create: if true;
      // Only admin can update/delete
      allow update, delete: if request.auth != null;
    }

    // Block all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
